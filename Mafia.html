<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Game</title>
    <link rel="stylesheet" href="mafia.css" type="text/css">
</head>
<body>
	<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
	<script>
		const firebaseConfig = {
			apiKey: "AIzaSyBxotqOEdkMoZfwgQtcWsVP2DcivfFinqM",
			authDomain: "mafia-7afa1.firebaseapp.com",
			projectId: "mafia-7afa1",
			storageBucket: "mafia-7afa1.firebasestorage.app",
			messagingSenderId: "350568178297",
			appId: "1:350568178297:web:8b0fa1721a336f5d232aa8",
			measurementId: "G-ZG0SK1MV9F"
		};
		firebase.initializeApp(firebaseConfig);
    </script>
    <script>
		var gamePhase = "start";
		// game phase can be - start, day, night, end.
		// player status can be - yes, no.
		const db = firebase.firestore();
		const gamesRef = db.collection('mafia');
		var isHost = false;
		var votePh = false;
		var st3 = ``;
		var docSaved = "";
		var mafiaKilled = "";
		var players = [];
		var status = [];
		function savePlayer(playerId) {
			const docRef = gamesRef.doc(params['gameCode']);
			docRef.get().then(doc => {
				const docSaved = doc.data()?.docSaved;
				if(playerId == docSaved){
				}
				else{
					const playerCard = document.getElementById(playerId);
					playerCard.classList.add('saved');
				}
			})
            
        }
		function toggleChat() {
			const chatBox = document.querySelector('.chat-box');
			if (chatBox.style.maxHeight === '40px') {
				chatBox.style.maxHeight = '300px';
			} else {
				chatBox.style.maxHeight = '40px';
			}
		}
		function getParams() {
			var idx = document.URL.indexOf('?');
			var params = new Array();
			if (idx != -1) {
				var pairs = document.URL.substring(idx+1, document.URL.length).split('&');
				for (var i=0; i<pairs.length; i++) {
					nameVal = pairs[i].split('=');
					params[nameVal[0]] = nameVal[1];
				}
			}
			return params;
		}
		function updateList(array) {
			const ul = document.getElementById("player-list"); 
			ul.innerHTML = ""; // Clear the existing list items
			array.forEach(item => {
				const li = document.createElement("li");
				li.textContent = item;
				ul.appendChild(li);
			});
		}
		function shuffle(array) {
			let currentIndex = array.length;
			while (currentIndex != 0) {
				let randomIndex = Math.floor(Math.random() * currentIndex);
				currentIndex--;
				[array[currentIndex], array[randomIndex]] = [
				array[randomIndex], array[currentIndex]];
			}
			return array;
		}
		function switchPhase(){
			const docRef = gamesRef.doc(params['gameCode']);
			docRef.get().then(doc => {
				gamePhase = doc.data()?.gamePhase;
				docSaved = doc.data()?.docSaved;
				mafiaKilled = doc.data()?.mafiaKilled;
				players = doc.data()?.players;
				status = doc.data()?.status;
				if(gamePhase == "night"){
					gamePhase = "day"
					if(mafiaKilled[0] != docSaved){
						status[players.indexOf(mafiaKilled)] = "yes";
					}
				}
				else{
					gamePhase = "night"
				}
				docRef.update({
					gamePhase : gamePhase
				})
			})
		}
		function startGame(){
			gamePhase = "night";
			const mafiaCount = document.getElementById('mafia-count').value;
			const docRef = gamesRef.doc(params['gameCode']);
			docRef.get().then(doc => {
				if(doc.exists) {
					var final_players = doc.data()?.players;
					var final_roles = []
					for(let i=0; i<final_players.length; i++){
						if(i<mafiaCount){
							final_roles.push("Mafia");
						}
						else if(i == mafiaCount){
							final_roles.push("Doctor");
						}
						else if(i - 1 == mafiaCount){
							final_roles.push("Detective");
							console.log("HI");
						}
						else {
							final_roles.push("Villager");
						}
					}
				}
				final_roles = shuffle(final_roles);
				docRef.update({
					gamePhase : gamePhase,
					roles : final_roles,
				}).then(() => {	
				})
			})
		}
		function voting(){
			if(votePh){
				votePh = false;
			}
			else{
				votePh = true;
			}
			const docRef = gamesRef.doc(params['gameCode']);
				docRef.update({
					votePh : votePh
				}).then(() => {
				})
		}
		function updatePhase(){
			const docRef = gamesRef.doc(params['gameCode']);
			docRef.get().then(doc => {
			gamePhase = doc.data()?.gamePhase;
			if(gamePhase == "start"){
				if(isHost){
					const st1 = `<div class = "identity-card"><h3>Game is yet to start</h3><input type="number" id="mafia-count" placeholder="Number of Mafia" min="1"><button onclick="startGame()">Start Game</button></div>`;
					document.getElementById('main-content').innerHTML = st1;
				}
				else{
					const st2 = `<div class = "identity-card"><h3>Game is yet to start</h3><p>Please ask the host to start the game</p></div>`;
					document.getElementById('main-content').innerHTML = st2;
				}
			}
			else if(gamePhase == "day"){
				if(isHost){
					const fp = doc.data()?.players;
					const fr = doc.data()?.roles;
					const fs = doc.data()?.status;
					const vP = doc.data()?.votePh;
					st3 = ``;
					for(let i=0; i<fp.length; i++){
						if(fs[i] == "no"){
							st3 += `<div class="player-card" id="player${i+1}"><h4>${fp[i]}</h4><div class="role">${fr[i]}</div></div>`;
						}
						else{
							st3 += `<div class="player-card eliminated" id="player${i+1}"><h4>${fp[i]}</h4><div class="role">${fr[i]}</div></div>`;
						}
					}
					document.getElementById('main-content').innerHTML = st3;
					document.getElementById('switch-phase').innerHTML = `<button onclick="switchPhase()">Switch to Night</button>`;
					if(vP){
						document.getElementById('switch-phase').innerHTML += `<p></p><button id="vote" onclick="voting()">End Voting</button>`;
					}
					else{						
						document.getElementById('switch-phase').innerHTML += `<p></p><button id="vote" onclick="voting()">Start Voting</button>`;
					}
				}
				else{
					
					
				}
			}
			else if(gamePhase == "night"){
				const fp = doc.data()?.players;
				const fr = doc.data()?.roles;
				const fs = doc.data()?.status;
				const fi = doc.data()?.ids;
				if(isHost){
					st3 = ``;
					for(let i=0; i<fp.length; i++){
						if(fs[i] == "no"){
							st3 += `<div class="player-card" id="player${i+1}"><h4>${fp[i]}</h4><div class="role">${fr[i]}</div></div>`;
						}
						else{
							st3 += `<div class="player-card eliminated" id="player${i+1}"><h4>${fp[i]}</h4><div class="role">${fr[i]}</div></div>`;
						}
					}
					document.getElementById('main-content').innerHTML = st3;
					document.getElementById('switch-phase').innerHTML = `<button onclick="switchPhase()">Switch to Day</button>`;
				}
				else {
					const role = fr[fi.indexOf(params['id'])];
					const status = fs[fi.indexOf(params['id'])];
					if(status == "no"){
						if(role == "Doctor"){
							st3 = ``;
							for(let i=0; i<fp.length; i++){
								if(fs[i] == "no"){
									st3 += `<div class="player-card" id="player${i+1}"><h4>${fp[i]}</h4><button onclick="savePlayer('player${i+1}')">Save</button></div>`;
								}
								else{
									st3 += `<div class="player-card eliminated" id="player${i+1}"><h4>${fp[i]}</h4></div>`;
								}
							}
							document.getElementById('main-content').innerHTML = st3;
						}
						if(role == "Detective"){
							st3 = ``;
							for(let i=0; i<fp.length; i++){
								if(fs[i] == "no"){
									st3 += `<div class="player-card" id="player${i+1}"><h4>${fp[i]}</h4></div>`;
								}
								else{
									st3 += `<div class="player-card eliminated" id="player${i+1}"><h4>${fp[i]}</h4></div>`;
								}
							}
							document.getElementById('main-content').innerHTML = st3;
						}
						if(role == "Mafia"){
							st3 = ``;
							for(let i=0; i<fp.length; i++){
								if(fs[i] == "no"){
									st3 += `<div class="player-card" id="player${i+1}"><h4>${fp[i]}</h4></div>`;
								}
								else{
									st3 += `<div class="player-card eliminated" id="player${i+1}"><h4>${fp[i]}</h4></div>`;
								}
							}
							document.getElementById('main-content').innerHTML = st3;
						}
						if(role == "Villager"){
							st3 = ``;
							for(let i=0; i<fp.length; i++){
								if(fs[i] == "no"){
									st3 += `<div class="player-card" id="player${i+1}"><h4>${fp[i]}</h4></div>`;
								}
								else{
									st3 += `<div class="player-card eliminated" id="player${i+1}"><h4>${fp[i]}</h4></div>`;
								}
							}
							document.getElementById('main-content').innerHTML = st3;
						}
					}
					else{
						const st2 = `<div class = "identity-card"><p>You have been</p><h3>Eliminated</h3></div>`;
						document.getElementById('main-content').innerHTML = st2;
					}
				}
			}
			else {
				if(isHost){
				
				}
				else{
				
				}
			}
			})
			setTimeout(updatePhase, 1000);
		}
		params = getParams();
		const docRef = gamesRef.doc(params['gameCode']);
		
		docRef.get().then(doc => {
			if (doc.exists) {
				var hostID = doc.data()?.hostId;
				if (params['id'] == hostID){
					isHost = true;
					var hostName = doc.data()?.host;
					document.getElementById('host-name').innerHTML = hostName; 
					document.getElementById('game-code').innerHTML = `Game Code : ${params['gameCode']}`;
					var ps = doc.data()?.players;
					updateList(ps);
				}
				else {
					var hostName = doc.data()?.host;
					document.getElementById('host-name').innerHTML = hostName; 
					var ids = doc.data()?.ids;
					var ps = doc.data()?.players;
					var playerName = ps[ids.indexOf(params['id'])];
					isHost = false;
					updateList(ps);
				}
			}
		})
		updatePhase();
	</script>
	<div class="header">
        <h3 id='game-code'>Welcome to Mafia!</h3>
    </div>
    <div class="container">
        <div class="sidebar">
            <h2>Game Host</h2>
            <p id="host-name"></p>

            <div class="players">
                <h3>Players:</h3>
                <ul id="player-list">
                    <li>Player 1</li>
                </ul>
            </div>
			<div class="switch-phase" id="switch-phase">
		</div>
        </div>
        <div class="main-content" id="main-content">
        </div>
		
    </div>
	<div class="chat-box">
    <div class="chat-header">
        <span>Chat</span>
        <button class="toggle-chat" onclick="toggleChat()">_</button>
    </div>
    <div class="chat-content">
        <ul id="chat-messages">
            <!-- Chat messages will appear here -->
        </ul>
    </div>
</div>
</body>
</html>
